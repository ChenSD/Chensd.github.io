---
layout: post
title:   ERP-EEG处理笔记
date:   2020-11-3 22:10:20
categories: toolbox
toc: true
---

# ERP实验设计编程和数据采集

* ERP实验设计和数据采集与行为实验存在较大的差别，具有一些特别的要求，如实验刺激的试次和类型。如果这两个步骤出现问题，则后期的数据处理就失去了大楼的基石。
* 在哔哩哔哩上看到一个up主的一句话，甚为赞同。安全的食品是生产出来的，不是检测出来的。科学实验数据也一样。干净的实验是做出来的，而不是处理出来的。这一点在ERP实验和fMRI实验上体现最深。前期的数据采集工作结束的时候，就已经决定了这批数据的命运。实验设计的不严谨，无关实验因素控制不严格，都可能导致得到的是一堆垃圾数据。面对垃圾数据，就算是再好的数据处理方法也不可能变废为宝！因此，在设计ERP实验和fMRI实验时，从材料选取，呈现流程，Mark标记到数据采集，要事无巨细，方方面面都要考虑清楚。任何一个方面的疏忽，都会导致百分百的实验失败。

## Experimental Design

1. 实验设计的第一步是根据实验目的选取可靠的实验范式。实验范式选取的第一选择是依据前人文献选择经典的，被反复验证的实验范式。如果前人范式无法满足实验目的，再在前人范式的基础上进行创新改进。另外，需要注意行为范式不能直接应用到ERP或fmri实验中，后者都有其各自的技术特点。
2. Ask yourself the following questions.

     1. Which cognitive processes do you want to study? Why do you want to use ERP approach to study it?

     2. Which ERP components you want to use to represent the cognitive processes of interest?

     3. Is your design in line with the ERP princinples (see Luck book for more detail)?

     4. How many trials? How many participants?

## Data collection

1. 准备哪些材料？ 脑电膏，棉棒，胶布，去角质膏，脑电帽和配套识别文件
2. 脑电实验特别注意事项：头动（超级影响数据），眼睛和屏幕间距，刺激呈现在屏幕中的位置和大小，房间电器的控制（电磁干扰）
3. 打电极膏注意事项，保证电阻达到理想较低水平
4. 数据采集过程中实时观察数据质量并记录

# ERP Components in the field of emotion regulation

1. 每个成分需要注意的事项：
   0. 基线的标准（-200ms）。
   1. 其参考点有没有特别要求，平均参考还是双侧乳突？
   2. 其空间分布的经典位置在哪些电极点上？
   3. 其时间分布的经典时间窗是哪些时间段？
   4. 其时间分段的通用标准是什么？
   5. 其常用的指标又哪些，振幅还是潜伏期？每个指标的心理学含义是什么？
   6. 其操作化定义，具体计算的方法是什么？

2. 建议：不要仅仅靠语句计算出ERP指标然后就去做统计。再这之前，肉眼观察每个测量到的
ERP成分。画出每个被试的波形图，观察比较其成分的波幅和潜伏期。这是因为被试间的波形
往往差异很大。   

## Early components (<300ms)

1. C1, P100, P200, N100, N170（面孔特异性）, N200,

2. Early Posterior Negativity (EPN), highly responsive to phylogenetically threatening stimuli

3. MisMatched Negativity (MMN)

4. Error-related negativity (ERN) typically peaks from 80-150 milliseconds (ms)
after the erroneous response begins

2. 关注哪一个早期ERP成分取决于实验刺激呈现的感官通道。不同的感官通道，如视觉和听觉，所诱发的
ERP成分（如N1），其到达顶峰的时间可能有所重合，但是头皮分布往往差别很大。
例如，与任务相关的听觉和视觉刺激都会诱发出N2b成分，但听觉刺激的反应在中央区最大，
而视觉刺激的反应在头后部最大。

## Late Components (>300ms)

0. P300 LPP N400（语言加工成分）
1. LPP： early (300-1000) and late (>1000) LPP
1. 必须以双侧乳突为参考点
2. 建议以图片呈现时间来进行分段，例如图片呈现4s，就以4s来分段。
3. LPP可以分为早期LPP（<1000ms），和晚期LPP
4. 计算方法：建议从300ms开始，以200ms为最小时间单位分段。

## ERP成分经典指标的计算

0. ERP成分的分析是基于头皮电位的分析。所以首先需要确定电极点（electrodes）-根据参考文献和综述。

1. 确定peak点。local peak amplitude method should be used, because it reflect the peak better
than the maximum voltage method (See Luck 2014). 可以使用matlab中的findpeaks函数实现。

``[pks,locs] = findpeaks(data) additionally returns the indices at which the peaks occur.``

2. 平均振幅。选用某些电极点peak前后某段时间窗内的电位平均值。
注意，这一方法不宜选用过窄的时间窗（<40ms）。这是因为虽然
更窄的时间窗能够更好地避免重叠成分的影响，但其受条件间、电极点之间以及不同被试间
变异的影响更大。

3. 潜伏期（latency），即经典成分peak出现的时间。

# ERP-EEG Data 整体流程

EEG数据处理的两大核心思想就是，降噪（排除干扰因素）和平均。

## EEG数据处理百科

1. [CIMeC Wiki on EEG Data pre-processing](https://wiki.cimec.unitn.it/tiki-index.php?page=Data+pre-processing)
2. [EEGLAB Wiki](https://sccn.ucsd.edu/wiki/EEGLAB_Wiki)

## 第一步，预处理流程

* 预处理之前，需要对EEG的数据结构（被试*试次*通道*时间*空间*频域）有一个清晰的认识，搞清楚EEG数据有几个维度。
* EEG数据的每一个维度上，都可以进行预处理以实现降噪。
* 不同软件设计的预处理流程会存在一定的差异。现在总结常用的几种预处理和后期处理流程：
     1. EEGLAB代码进行预处理，包含分段（epoch）；使用EEGLAB或fieldtrip代码进行组分析；
     2. EEGLAB代码进行预处理，不包含分段（epoch）；使用ERPLAB进行分段（erplab的术语叫建立erplist，assiganbins）和ERP组分析
* 第一个流程基本上是全部代码流程，最后的绘图和数据导出都需要代码实现；流程2ERPLAB自带绘图和数据导出功能，而且目前还有新的数据质量检测功能加入。



### 准备工作

1. Prepare data1. 检查被试的命名是否统一（e.g., sub01_name.*）,
检查所有被试的marker命名是否正确；

2. Prepare data2. 如果存在不一致的问题，例如由于编程时问题，marker名称不统一或重复，
使用语句对marker进行重命名。确保数据中，实验条件与marker一一对应，没有错误。

3. 确定预处理参数：离线参考点。主要离线参考点如何选择（全脑平均还是双侧乳突，或者鼻尖参考）。分析目的和指标不一一，参考也不一样。    
     * the target ERP component: linked mastoids are good for components with vertically oriented dipoles (e.g., P300),
     whereas average reference is better for lateralized components (e.g., P1/N1);
     * the planned analysis: if you plan to run topographical analysis or estimate neural sources, you have to use average reference.
      For more information, see:
      Issues in the application of the average reference: Review, critiques, and recommendations (Dien, 1998, BRMIC)
      For a short, informal discussion on the topic, see https://sccn.ucsd.edu/pipermail/eeglablist/2008/002510.html
3. 确定预处理参数：高通滤波。
     * High-pass filtering above 1 Hz had dramatic effects on ERP shapes. 0.1Hz is common for ERP study [Does filtering preclude us from studying ERP time-courses?](https://www.frontiersin.org/articles/10.3389/fpsyg.2012.00131/full)
     * There is a published study showing that high-pass filter up to 2Hz improves ICA's performance. See this paper by Winkler et al.(2015).
4. 确定预处理参数：重采样
 	 * Downsampling to something like 100 Hz is generally recommended for connectivity analyses.
	 * TFA分析最好不要重采样

### 第一次预处理

1. 第一次预处理目的：生成基于1HZ高通滤波数据的ICA矩阵信息。[基于1-2Hz做ICA的论文](https://www.researchgate.net/publication/281290619_On_the_influence_of_high-pass_filtering_on_ICA-based_artifact_reduction_in_EEG-ERP)
2. EEG的数据的信息可以分为两大类别：时间信息和通道（空间）信息。注意，时间和空间信息的处理不是串行进行的
而是你中有我，我中有你。
3. 想哥思路，想哥之前代码的思路是使用cleanline，clean_rawdata等对时间上的信息进行去噪；
空间上，使用set_channel_types函数把通道分为EOG,bad,eeg等几个大类：
     第一大类非脑通道，包括VEOG,HEOH，ECG等；
	 第二大类为坏道，例如前额叶的点由于阻抗很大，一般信噪比很差；
	 第三大类就是正常的大脑通道，如Cz等。
想哥是在ICA之前，就把三大类的通道区分开来。ICA的时候只输入正常大脑的通道。
4. 需要学习的是，想哥代码在处理时会把去除的坏段，坏导等，都记录下来（存到bk中）。这有利于数据的QA。例如，在预处理后对所有数据中的坏段数据进行汇总分析，可以计算出每个被试数据的留存率，以及组水平上有效数据的留存率。
5. [SCCN Makoto's preprocessing pipeline](https://sccn.ucsd.edu/wiki/Makoto's_preprocessing_pipeline#Adjust_data_rank_for_ICA_.2805.2F17.2F2019_updated.29)
Makoto在2020年的处理流程中，跟想哥的处理流程有几点改善的地方：
     1. Makoto强烈建议跑ICA的时候，如果EOG跟eeg通道用的同一参考，就使用这些通道。[EEGLAB论坛里也有不少人支持
	 不要在ICA之前删除EOG通道，而是把EOG数据输入到ICA中，这样可以提高ICA区分眼动成分的能力。](https://sccn.ucsd.edu/pipermail/eeglablist/2015/009720.html)
	 2. 去线性噪声的插件由cleanline换为Prep
	 3. Makoto建议（可选）在ICA之前对数据进行分段，以便ICA的结果在时间维度上更契合ERP分段数据；否则ICA就是在连续数据上所得出。我想这里可以只分段，但不需要去除坏段。
	 因为ICA前的数据包括了EOG等绝对属于non-brain噪声，而去坏段的时候是把所有通道平均再去掉，所以EOG这些non-brain通道的存在会导致epoch的信噪比很差，很容易全部去掉。
6. cleanRaw参数的设置需要非常注意。设置过于激进会删除大部分的数据。而且clean_rawdata()的帮助给的参数并不很好。
[cleanRaw参数具体可以参考此教程](https://deniskozhokar.org/eeg-dataset-2/)：
     EEG = clean_rawdata(EEG, 1, -1, 0.8, -1, 8, 0.25);

     %The first box provides information on any flat channels
     %The second box is disabled (-1) because FIR high-pass filter is already applied.
     %The third box means that if a channel is correlated to the surrounding channels less than 0.8, the channels is rejected. If it rejects too many channels, use less value.

     %The fourth box is disabled (-1) because line noise is supposed to be already taken care of (with Cleanline)

     %The fifth box is the ASR （该选项不会删除数据，而是会用插值计算的方法修补不良数据）. This is the point. Finds calibration data (i.e. the cleanest part of data)
     %Apply 1-s sliding window principal component analysis (PCA) on the continuous data. Classify PCs into high variance (in this case, 8 standard deviation from the
     % calibration data) or normal variance.
     %Reconstruct high variance subspace (i.e. group of channels associated
     %by a PC) with normal variance subspace. An important assumption is that
     %neighboring channels are heavily correlated due to volume conductance and scalp mixing
     %because of this, the central limit theorem works and the scalp channel signals
     %become closer to Gaussian than source signals; this guarantees ICA. See also Arnaud Delorme's
     %explanation of ICA as non-Gaussianity maximization). This is how you
     %can estimate a signal of one channel from signals of adjacent channels.
     % [Makoto advises a value that is conservative (from 10-20)](https://sccn.ucsd.edu/wiki/Makoto's_preprocessing_pipeline#Alternative.2C_more_automated_pipeline_using_ASR_.2811.2F13.2F2019_updated.29), for the
     %purpose of correcting only absolutely bad glitches that critically influences ICA's performance.
     %Nima's result showed that ASR with SD=20 produced the best result.
     % The understanding is to let ICA explain the data as much
     % as possible so the correction using PCA-based method should be minimized, and the
     % empirical balancing point is somewhere around 10-20.

     %The sixth box is the window rejection criterion（default=0.25）. 如果第四个选项的ASR无法修补的数据，该选项设置后就会将其删除掉。

5. 第一次预处理的时候是否要用clean_rawdata先去除坏导，再补回坏导，甚至说要不要还有clean_rawdata进行ASR的数据修补？
我想至少不能去除坏导再补回，因为这样EOG等很可能被直接去掉了，补回来的数据就不再能反映眼动。失去了在ICA中加入EOG的意义。ASR感觉还是得做，
因为ICA是一种平稳信号降维（stationary signal decomposition）技术（ICA也能应用到非稳态数据上，只是效果好不好的问题）。不使用ASR修补数据的话，数据的不稳态性质很高。ASR应该可以提高数据的稳态性。
6. ICA参数的计算。主要需要计算的输入参数就是数据的data rank，其取决于通道数目。务必保持两次预处理通道数目的一致。
7. ICA方法的选择：


### 第二次预处理

1. 应用上一次生成的ICA矩阵信息，并对数据进行分段，剔除坏段。
2. 注意不能在ICA之前把EOG等通道删除，否则会因为ICA矩阵维度不一致报错。
3. 两次预处理的重参考方法需要保持一致。

### 眼电剔除

1. 手动（半自动）： 利用EEGLAB Adjust插件半自动化地去除眼电的ICA成分。
2. 全自动：ICALabel


## 第二步，检查数据，保证质量

有些被试由于头动等莫名其妙的原因，其电位可能比正常被试的数据大几十倍。In this case,
这一个极端被试的混入就能左右结果的显著性。为了避免这种极端值，需要对数据进行质量控制，
剔除极端被试，避免污染结果。

1. 对每个被试的感兴趣成分进行绘图，观察电位强度范围，以及ERP波的走向。
例如LPP的波幅强度（就情绪唤起而言），一般在10-15左右。如果一个被试的电位到了100，
这个被试很可能就会影响结果的显著性。而且这种被试的原始数据一般也会有问题，怎么剔除坏段
都救不回来。Rubbish in, rubbish out.
2. 求出所有被试某个成分的值，直接观察原始值。然后重点对极端值绘图。
3. 注意，第一步和第二步并不是严格的时间先后顺序，两者应该是交互进行的。

## 组分析

### 方案一：使用ERPLAB进行组分析（时域）

* 使用ERPLAB进行组分析的优点在于ERPLAB自带较好的后期绘图和数据导出代码
* 使用ERPLAB进行组分析，需要注意的是前面预处理的时候不可以进行分段。ERPLAB只识别连续数据，分段后无法识别。
* [ERPLAB官网manual](https://erpinfo.org/erplab)
* ERPLAB处理基本流程：ERPLAB——CreatEventlist——Assignbins——Extract bin-bassed epochs。后面依次往后点就可以。单个被试数据分析完之后，就可以输出代码，改成组分析循环批处理即可。

### 方案二：使用fieldtrip进行组分析（时频）

* EEGLAB的组分析代码，或者ERPLAB插件可以进行较好的时域分析，但时频分析不友好。所以
时频分析使用fieldtrip来做。
* 注意fieldtrip的预处理流程包含分段。
* 一般流程：
    1. EEGLAB代码进行预处理
    2. 将EEGLAB预处理后的数据转换为fieldtrip可以识别的格式
    3. 使用fieldtrip进行时频分析

### 方案三：使用Evoked ERP-ERO Toolbox汇总数据和时域或频域统计分析

#### 数据汇总

* Evoked ERP-ERO Toolbox该工具包只进行时域，频域或时频的组分析，并不提供预处理功能。因而可以很好地替代EEGLAB的Study功能。

* 首先需要将预处理后的数据中的试次进行平均，然后按照条件拆分为每个被试每个条件一个数据。
* 然后，使用Evoked ERP-ERO 提供的汇总工具Evoked ERP ERO_v1.1_Forming_fourth_order_tensor_demo data来合并数据，得到四维的汇总数据。就是一个代码，无需修改直接运行出现GUI界面，填写所需参数，选择所需数据，就可以傻瓜导出后续分析所需的四维数据。
* 最终得到的用于ERP分析的数据是一个四维数据，四个维度分别为通道（chanells），时间点（time points），被试（subjects）和条件（conditions）。
* Evoked ERP-ERO 工具箱提供的合并数据代码会生成两个数据：
     1. 一个是同时包含实验设计信息和数据信息的‘…_structure.mat’文件，可以直接在>File>Import the processed data’ 中导入Evoked ERP-ERO 工具箱，无需二次输入实验设计信息；
	 2. 二是只包含被试数据信息的四维数据，‘test_fourdiemension_fourth_order_tensor’。需要在‘>File> Import fourth-order tensor & parameters’导入。导入时，需要再次填写实验设计信息。
* 汇总原理：平均试次维度，计算出所有被试，所有条件，所有时间点，所有通道的平均值。
最后的数据就是一个四维数据，在Matlab中为mat格式文件。时频分析的数据为五维数据，相比ERP汇总数据多了一个频率维度。但是注意Evoked ERP-ERO Toolbox不需要先进行傅立叶变换得到五维数据再进行分析，其可以直接在四维数据的基础上进行时频变换和时频分析。

#### Time domain analysis (ERPs分析)

1. 输入ERP_ERO打开数据，导入之前计算好的四维数据，默认为Dataset 1, 可以添加备注便于识别,如Dataset Raw.
2. 可以先在>Time domain analysis> Conventional time domain analysis > Plot waveform & topo绘制波形图和地形图查看下结果。
3. 然后，在Matlab命令行窗口按任意键，出现set the parameters for plotting top窗口，输入感兴趣的时间段以及指标类型（均值还是peak）。确认后，绘制出地形图和被试间相似性矩阵。之后，会在最初数据上生成新的数据集，如Dataset_Cz。
4. 最后，可以选择在ERP_ERO内>Statistical analysis> Within-subject rm-ANOVA直接进行统计分析；也可以选择Outputdata导出数据到excel，再使用SPSS进行分析
5. 如果想要换电极点重新分析，需要在Dataset里回到最初导入的数据集开始分析。
6. 此外，还可以先对Dataset Raw在时域上做一个PCA分析，即主成份分析。Time domain analysis>t-PCA>Run t-PCA. 此处成分数目的选取根据The explanation of varience界面中第四个成分贡献百分比图来确定。例如图中说22个成分贡献了99%，那么就可以确定22个成分即可。后面利用被试间的相似性以及该成分的贡献度来确定分析成分。确定成分后，在t-PCA选择该成分，绘图。最后可以在该成分上进行统计分析。

#### Time-Frequency Analysis (TFA)分析

1. 使用ERP_ERO载入数据后，>Time-frequency analysis > Morlet CWT> Run Morlet CWT，即可以使用连续小波变换（Morlet CWT）对数据进行时频变换，得到每个被试每个条件下频域的信息。
2. 数据结构解读： 与ERP不同，TFA数据分析还需要在预处理后再进行时频变换，最后得到汇总的一个五维数据。与ERP汇总数据相比，多了一个频率维度。因此，TFA分析中ERP_ERO的数据结构EEG_ERO.data有五个维度，而ERP分析中该数据只有四个维度。至此，个人也可以完全使用代码提取出五维数据，根据自己感兴趣的时间-频域进行后续分析
2. 在对数据进行时频变换之后，就需要确定自己感兴趣的时间（起止时间）-频域（起止频域），类似于fMRI分析中的确定ROI。ERP_ERO提供了两种方法来确定ROI：
    1. 传统方法：结合前人文献和当前数据结果，确定一个长方形来圈定ROI。
	2. 新方法，利用边界检测方法确定感兴趣震荡区域。
3. 最后，可以对不同实验条件在ROI内的能量值（power）进行统计比较，或者导出每个条件下每个被试ROI内的能量值进行后续分析。

## 第五步，绘图

1. 了解常见的图形类型，含义以及绘图要求：
    1. 地形图
	2. 波形图
	3. 能量示意图（X时间，Y频率，能量为填充）
2. 掌握Matlab和R（ggplot2）语言绘图技巧


# EEG数据分析的三种基本分类

## 1. 时域分析

时域分析只考虑信号电压强度随时间变化的规律，不考虑频域信息。时域分析大体可以分为以下几个类别。

1. 常规ERP分析。比较不同实验条件下的特定ERP成分的强度。
     * 锁时（time-locked）指锁时一般是按照刺激的onset叠加平均。ERP成分的锁时特性是试次平均之后能够得到ERP的根本前提，因为如果大脑对刺激不出现在同一个时间段内，平均就没有意义了。量化锁时可以通过分析时域的ERP 波形或者时频域内的ERSP(event-related spectral perturbation)来获得。ERSP能够衡量刺激相关的能量相比基线的变化。具体而言，实验能量（谱分布）的叠加之后得到ERSP图，如果ERSP相对于基线有所提高或降低，就说明能量对于时间锁定得很好；而如果ERSP没有随着时间变化则说明能量对于时间没有锁时关系。如：ERP和ERS相对于基线能量都有所提高，而ERD相对于基线能量有所降低，所以ERP ERD/ERS都是time-locked的。
	 * 锁相(phase-locked)。相位是反映波形的走势，是跟能否获得好的ERP相关的。如果得到好的ERP波形，那么可以说多次的实验中，大脑对刺激的反应的相位也是很一致的，亦即，波形的走势是很一致的，也就是说相位很好地锁定了，同时可以说不同的试验数据相关性很强。量化锁相可以通过分析时频域内的ITC(inter trial coherence)来获得。一般来说，ITC越接近于1，越说明不同的实验，大脑对刺激的反应的波形走势越一致，相位就锁定得越好，那么就很可能通过平均获得很好的时域内的ERP波；相反，如果接近于0，说明相位没有锁定关系not phase-locked，则很难获得ERP了。
	 * 总之，叠加平均能出得来的东西，必须既time-locked又phase-locked，如ERP。因此锁时锁相是能够得到良好ERP波形的前提。但是，锁时锁相并不是和ERP以及频谱分析相对应的，不锁时锁相也能得到结果，不过可能是很烂的结果。
	 * 参考文献： David et al., 2006 NeuroImage 31 1580 – 1591；Basar et al. (2001)和Yener et al. (2007)讲述了一些关于锁相的问题。

2. 时间信号相关分析，认知神经科学一般称之为功能连接（functional connectivity）。计算功能连接有两大基本要素，第一选择ROI并提取该ROI内的时间序列信号；第二，计算ROI之间的相关系数。
     * ROI的选取。如何通过不独立的EEG信号得到独立的大脑皮层ROI信号？
	 * 相关方法的选择。直接使用相关方法存在许多问题。同步似然指数，信号能量的包络（Hipp et al., 2012 Nature Neuroscience: Large-scale cortical correlation structure of spontaneous oscillatory activity）。参考雷旭老师博客。
	 * 推荐HERMES工具包。HERMES是由西班牙马德里技术大学（Technical University of Madrid）的Centre for Biomedical Technology团队研发的基于Matlab的开源EEG工具包，其主要的功能和特点是计算基于各种方法的功能连接，HERMES官方网址：http://hermes.ctb.upm.es/


## 2. EEG频谱分析

频域分析。一般称为频谱分析，在频域上我们可以对一个信号在不同频率下的信息进行分析，如振幅、功率、强度或相位等。频谱分析只考虑信号功率强度随频率的变化规律，不考虑时间信息。
较为常见的EEG频谱分析有：
     1. 绝对功率
	 2. 相对功率
	 3. EEG功率谱密度分析(Power Spectral Density, PSD)，研究信号功率随频率变化的规律。

## 3. 时频分析(Time-Frequency Analysis, TFA)

同时考虑时域和频域信息，对特定时间段和特定频率范围内的信号能量强度进行分析。

### 3.1 Basic terms

0. 常见术语：
    Time-Frequency Analysis, TFA
	Event-related spectral perturbations, ERSP
1. In signal processing, Time–Frequency Analysis (TFA) comprises those techniques
that study a signal in both the Time and Frequency Domains (TFD) simultaneously.
2. 脑电波中α频段（8~12Hz）和β频段（13~30Hz）的振荡(降低和增强)可以显示出事件相关的中止反应或事件相关的增强, 其中前者被称为事件相关同步化(event-related synchronization, ERS),
后者称之为事件相关去同步化(event-related desynchronization, ERD).
3. ERS和ERD具有以下特性(参考自刘刚&孙伟, 2011):
    1. 频段特异性: alpha和beta频段的ERD可作为大脑激活的指标，
	而ERS的出现则表明大脑处于失活状态，提示皮质区域恢复到静息或惰性状态(Pineda 2005) 。
	与之相反，gamma频段的ERS 与皮质激活相关，可能参与多区域和多种模式的信息整合加工过程(Cheyne, et al., 2008) 。 不同频段在正常和病理的运动加工过程中表现出不同的振荡模式，表明在大脑皮质和皮质下水平可能有着相互作用的独立功能调节机制来参与运动神经环路的信息加工。
	2. 锁时性: 前人EEG和MEG的研究发现感觉运动皮层的神经反应振荡活动在运动开始前几百毫秒出现并持续到运动结束后几秒钟。
	例如，在运动开始前几百毫秒，alpha和beta频段的能量会迅速降低（ERD），在运动结束之后１ ～２ ｓ beta频段能量会迅速增高（ERS）(Pineda 2005)
4. 情绪相关研究中, ERS和ERD往往用于确定感兴趣的时间-频率窗(TFD of interest)
5. 常见因变量指标：
     1. 能量/功率谱密度（power spectral density, PSD）. 确定好感兴趣的TFD之后, 就需要从感兴趣的TFD中提取每个实验条件的节律能量.
     2. 相位一致性(Phase Locking Index, PLI)
	 3. 耦合(Coherence). 不同电极同频率信号的相位同步性(Phase Synchrony)

### 3.2 时域到频域的常见方法

1. 短时傅立叶(short-time Fourier transform,STFT)变换，可以对感兴趣的较低的频率进行分析。STFT有诸多优点, 但是也有两大缺点:
	 1. First, it treats the power within the window as if it was the power at the center of the window, even though the entire window contributes equally to the power measurement.
     2. STFT依赖于一个固定的时间窗. 而时间窗的长短直接影响时间分辨率和频率分辨率. 窄窗口时间分辨率高但频率分辨率低, 宽窗口时间分辨率低但频率分辨率高. 对于时变的非稳态信号(EEG信号就是典型), 高频适合用小窗口, 低频适合用大窗口.

	然而STFT的时间窗是固定的,在一次TFA分析中是不会变化的. 因此, STFT无法满足非稳态信号变化频率的要求.
[](/images/2019-12-27_ERP1.jpg)

2. 采用小波变换,这里主要使用的是Morlet wavelets。[小波变换并没有采用窗的思想，更没有做傅里叶变换。小波直接把傅里叶变换的基给换了——将无限长的三角函数基换成了有限长的会衰减的小波基。这样不仅能够获取频率，还可以定位到时间了。](https://www.cnblogs.com/jfdwd/p/9249850.html)
用高斯函数(Gaussian function, bell curve) function)乘以正弦波就成了Morlet小波。但是，小波分析中使用到的小波函数多种多样。小波分析在工程应用中,一个十分重要的问题就是最优小波基的选择问题在使用小波变换时，小波基函数的选择非常关键（丛丰裕老师讲座）。
3. 小波变换有两个变量：
     1. 尺度a（scale），尺度a控制小波函数的伸缩，尺度就对应于频率（反比）
	 2. 平移量 τ（translation）。平移量 τ控制小波函数的平移，平移量 τ就对应于时间。
4. 那么怎么选择合适的小波基函数？光靠想是不行的，需要结合实际数据进行绘图检查：


### 3.3 General Steps

1. 总体步骤: eeglab里面前面的preprocessing是一样的，只是后面处理的时候选TFA或者ERP
2. 函数. 利用每个被试的预处理后的文件，可以进行时间-频率分析。EEGLAB主要采用自带的newtimef()函数进行时频分析.
newtimef()函数中进行TFA分析的核心函数有如下选择:
    * 第一, 短时傅立叶(short-time Fourier transform,STFT)变换
	* 第二, 采用小波变换,主要使用的是Morlet wavelets。

3. 画图. TFA分析主要涉及两个图:
    * 第一个是总平均时间-频率图. 该图是指根据newtimef()进行参数设置后，计算每个被试每种条件下的时频图，然后进行平均得出的。基于总平均时间-频率图, 可以通过肉眼得到感兴趣的TFD.
	* 第二个是感兴趣的频率的时间能量波形图。该图是根据自己感兴趣的TFD，只计算和分析自己感兴趣的频带的能量分布图。
4. 数据. 要画出上述两个图，首先必须建立总平均时间频率文件, 即被试*条件*channel*time*frequency的数据. 这个文件是进行后续数据处理的基础. 基于这一数据, 后续分析如下:
    * 第一, 平均掉总数据集中的被试,通道和条件维度, 获得time*frequency的二维数据. 基于这一二维数据, 即可绘制总平均时间-频率图.
	* 第二, 根据总平均时间-频率图得到感兴趣的TFD之后, 即确定了所需要分析的具体波段和具体时间窗口.
	* 第三, 根据所确定的TFD(已确定的时间和频率), 从总数据集合中提取出每个被试在每个条件下该TFD的ERSP的值，然后根据该数据进行进一步的统计分析(如ANOVA)。
5. 基线矫正(Baseline Correction). 主要基线矫正方法有如下三种:
    * some studies subtract the average baseline power at a given frequency from the power at each poststimulus time point for that frequency.
	  * Other studies use division rather than subtraction (i.e., for each frequency, the power at each poststimulus time point is divided by the average prestimulus power).
	  * In other studies, the change between the prestimulus baseline and the poststimulus period is represented
	on a log scale (decibels) to take into account the fact that power typically falls off as the frequency increases.

### TFA画图注意



### 3.4 具体流程

有多种选择，常见的如:
1. 使用EEGLAB自带的功能进行时频分析. 但是EEGLAB的组分析study功能特别难用. 优点是只要study建好了, 后续也可以直接点点点.
2. [letswave教程：脑电数据的时频分析/组平均与统计分析](https://mp.weixin.qq.com/s?__biz=MzI0MTQxNDE5NA==&mid=2247486652&idx=1&sn=8eb5ea69daae3f7d7642312e20edf53a&chksm=e90ab5e1de7d3cf7691ddb8274de58d4d2171c98494fb942a3762cc6492e32d26fd33f5613a4&mpshare=1&scene=1&srcid=1227zlBZaMesgcvkMjWUYxyB&sharer_sharetime=1577414424843&sharer_shareid=4905f7abc86408fc345b135a8501550f&key=288743bececaa03f8f0e198e3d692dcf58b796503fc225ede3c6500ded0fc7aa67f118fade53f6270ec123578516d5b74fe810ef1ad3f20e7ccfd930908d7beeeeed7fcee55c1ae0e25dc8dcab4d818b&ascene=1&uin=MTcxODg3OTg2NA%3D%3D&devicetype=Windows+10&version=62070158&lang=zh_CN&exportkey=AZD6CxAiOt%2BiN1ZvdX1vcyc%3D&pass_ticket=Z8hRh0Kh90VixkwSwMz%2BqrY7kBDwhm%2BIOsk1Debq0tEGSxp2si0u7siscgypmtx0)
	letswave的优点在于不用编写代码, GUI全程点点点就可以得到结果.
3. Fieldtrip

# 脑电新技术

1. 超扫描技术. 例如可以研究夫妻/双胞胎之间的脑电信号同步性(心有灵犀一点通)
2. 空间复杂度(spatial complexity, SC). SC提高, 独立神经活动越多, FC减弱. 作为一个新指标, SC的在认知控制(冷加工)和情绪加工(热加工)中的含义需要进一步挖掘.
3. 颅内ERP：
    1. Pourtois, G., Spinelli, L., Seeck, M., & Vuilleumier, P. (2010). Temporal precedence of emotion over attention modulations in the lateral amygdala: Intracranial ERP evidence from a patient with temporal lobe epilepsy. Cognitive, Affective, & Behavioral Neuroscience, 10(1), 83-93.
    2. Krolak-Salmon, P., Hénaff, M. A., Vighetto, A., Bertrand, O., & Mauguière, F. (2004). Early amygdala reaction to fear spreading in occipital, temporal, and frontal cortex: a depth electrode ERP study in human. Neuron, 42(4), 665-676.
=======
3. 推荐使用Evoked ERP-ERO Toolbox。可以很好地衔接预处理数据。相当于是EEGLAB Study功能的优化版。

# Advanced EEG methods

## 溯源分析

1.[溯源分析介绍](https://zhuanlan.zhihu.com/p/85780097)
2. 溯源分析算法：Asadzadeh, S., Yousefi Rezaii, T., Beheshti, S., Delpak, A., & Meshgini, S. (2020). A systematic review of EEG source localization techniques and their applications on diagnosis of brain abnormalities. Journal of Neuroscience Methods, 339, 108740. https://doi.org/10.1016/j.jneumeth.2020.108740
3. 正向求解（forward resolution）是从大脑到头皮，是以多算少，存在唯一解。逆向求解（inverse solution）就是溯源，从头皮到脑空间。某个头皮位置（CPz）的电位波形可能是又多个不同脑区的共同放电所形成。
4. 大脑模型（head model）describes the electrical conductivity (导电性) distribution inside of the head, which is the link between the dipole sources and the EEG / MEG signals.
脑模型可以由个体的MRI结构像来计算其脑内导电性的分布情况。如果没有结构像，可以用标准脑模型。大脑模型包含以下要素：
     • Geometrical properties of the head
     • Electromagnetic properties of the head
     • Position of the electrodes

5. 在得到脑容积导电模型（head model）后，就可以计算出脑的源空间模型，即理论上大脑偶极子（放电体素）的分布模型。源空间（Source space）模型（source model）：
     • The number of dipoles
     • Location of the dipoles
     • (clustering of dipoles)

6. 由于溯源求解中，是以少算多，由少数头皮通道求解大脑源空间中几千个甚至几万个偶极子，这种计算理论上有无穷解，无法得到唯一解。
因此，溯源算法都会对源空间设立了限制性的假设。在计算的多个源空间中，根据假设进行最优化求解，找到最符合假设的解。主要的
溯源方法有如下几个：
     * MNE：假设大脑功能具有经济最优化（最大效率，大体是这个意思）的特性。计算中寻求效率最大的模型。  
     * eLoreta：假设大脑的偶极子在空间上存在平滑性，即逐渐过渡，相邻的偶极子存在相似性。  
	 * beaforming（fieldtrip）：假设大脑不同脑区之间的活动相互独立
7. 溯源之后得到的偶极子空间里，每个偶极子会有三个方向。相当于大脑体素具有三对阴阳电极，会向三个方向放电。
这样显然不符合大脑放电的生理结构模型。大脑结构中，只有椎体细胞具有典型的开放电场结构（大部分是闭环的？），它们同步活动产生的同一方向的电活动才有可能让我们在头皮记录到电位。
因此，还需要对偶极子的方向进行合并。合并方向的方法主要有两种：
     * data-driven: 通过PCA方法找到解释程度最大的方向
	 * 理论驱动：根据生物学假设，把三个方向投射到垂直方向

## 功能连接

1. 无论是在时域还是频域，都可以分析两个或多个信号之间的共変性程度。
2. 源空间上的功能连接，一般是在ROI尺度上进行。这就需要先求出ROI源空间的电极方向。计算ROI电极方向的常见方向有：
     1. 直接平均
	 2. PCA
	 3. 中心化，类似于以ROI中心的偶极子为准来对齐。
计算完ROI电流的方向，再计算ROI之间的功能连接。
3. 为什么不建议在头皮上做功能连接?因为存在共同源问题（common source problem），即大脑两个头皮电极之间的信号存在相关，
可能是因为它们具有共同的神经信号发生源（脑结构放电基础一样）。

4. 脑电功能连接的常见指标：
     1. 时域，相关性(correlation)，描述两个时间序列时域的相似性
     2. 频域，相干性(coherence )，描述两个时间序列频域的相似性

# Toolbox

## 1. 商业软件

1. BP公司：Brain Vision Analyzer2

2. Neuroscan： SCAN

## 2. Open-source packages

1. Matlab-based
   1. Brainstorm 有GUI，Support for multiple modalities | MEG, EEG, sEEG, ECoG, NIRS, electrophysiology. 可视化功能超级强大，难以匹敌。
   2. EEGLab 有GUI
   3. STATLAB：https://mp.weixin.qq.com/s/lwT0SHA1pKfTjN3Ea78Frw
   3. FieldTrip NO-GUI  
   4. [The Batch Electroencephalography Automated Processing Platform (BEAPP)](https://github.com/lcnbeapp/beapp)
   5. Evoked ERP-ERO Toolbox （专注ERP-EEG组分析）
  短线完成任务，brainstorm和eeglab；长线搞研究的话，用fieldtrip，可以知道各种分析都是怎么回事。brainstorm的问题，比起EEGlab和 fieldtrip，是他们没有对领域原始贡献，就是把别人的方法借来，写成工具包，优点就是好用，方便，‘傻瓜’。

2. Python-based: [MNE](https://martinos.org/mne/stable/index.html)

3. R-based: http://onlinelibrary.wiley.com/doi/10.1111/psyp.12299/abstract


# BrainStorm学习笔记

## 安装和数据导入

1. 安装。需要先注册才能在官网下载，matlab中启动brainstorm的时候也需要先登录帐号才可以。Brainstorm安装涉及四个文件夹：
    1. 工具包文件夹，如eeglab一样，需要setpath
	2. 数据库文件夹，必须命名为brainstorm_db，而且一旦建立就不可以移动或删除。如果有改变，必须重新设置。
	3. 用户个人相关配置文件夹，默认即可
	4. 个人数据存储文件夹，自定义即可，但不能跟前面三个文件夹有重合。
2. 数据导入（io）。Brainstorm既可以导入原始的未经预处理的EEGLAB数据，也可以导入预处理后分段的EEGLAB数据。主要io函数：bst_process。具体导入数据步骤：
    1. 先打开软件，brianstorm
	2. 以实验名称建立一个protocol
	3. 使用代码批量导入被试。注意代码必须在建立protocol之后才可以运行。
3. 数据导入时注意原始数据的电极点的分布是否符合实际情况。可能出现电极点跑到了头皮下面，这时候就无法进行溯源分析。需要Add EEG position. 这一步可以写到代码中批量进行，也可以导入数据后，选中所有被试，拖入process使用GUI方式进行。
3. 数据平均。
    1. Drag and drop all the subjects in Process1. Select button [Process recordings].
    2. Select process Average > Average files: By trial group (subject average)
Arithmetic average, No Weighted (因为保留的都是good trials)
    3. Add process Average > Average files: By trial group (grand average)
Arithmetic average, Not weighted

## ERP分析

## TFA分析

1. [组分析](https://neuroimage.usc.edu/brainstorm/Tutorials/VisualGroup)

## 溯源分析

1. 先计算每个被试的头部模型(head model)。前提是确保EEG position（即每个电极点的分布）正确无误。有问题会提醒进行修改。
2. 计算head model选择方法，bs提供了两种空间设置（皮层表明和MRI全脑），三种计算方法：
     1. OpenMEEG BEM
	 2. 3-shell sphere
	 3. DUNEURO EEM
3. Compute Source

### 参考文献：

1. EEG Source Imaging: A Practical Review of the Analysis Steps
2. EEG Source Analysis: Methods and Clinical Implications

# Notes

1. [what are ERPs and what are they good for？](https://mp.weixin.qq.com/s/4aUtJnT9Me-mmgdy4-lpHA)
2. [ERP研究中如何设置刺激呈现时间，ITI、SOA？](https://mp.weixin.qq.com/s/4Qn-zx-rv_GDlFpjiCtYTA)
3. [EEG来自于哪里？有什么意义？](https://mp.weixin.qq.com/s/cLHBTjSQF6ohmwhwK-U3Iw)
4. [技术帖 | 如何在任何一项ERP实验中发现显著的效应](https://mp.weixin.qq.com/s/ifyxia0BkC4niGPCjaOw7w)
5. [ERP实验设计逻辑与实验范式](https://mp.weixin.qq.com/s/Wg9IZoLSS9ZYXo6dTD68qA)
6.

# EEG的临床应用

1. [儿童精神病理研究中EEG生物标记的使用现状和未来方向Research Review: Use of EEG biomarkers in child psychiatry research – current state and future directions](https://mp.weixin.qq.com/s?__biz=MzU0NTc5NDM1NQ==&mid=2247491002&idx=1&sn=0a23538a6c9dd15bce96d3375b7ef67f&chksm=fb662de6cc11a4f09a5cd11043064772fe3ce130e1cdfeaa53725f5deeb4a82e729e474ae692&mpshare=1&scene=1&srcid=0622jfgSwn2DHpePgq3V1S5i&sharer_sharetime=1592793671849&sharer_shareid=4905f7abc86408fc345b135a8501550f&key=39e50617cb648bc7ab436fed741403f620c5f62c6a87d711f189b9420eea1559393f0ff11fdfd612f77fae7d5a08d35570699f6e1e5560b20d7413917139eaf10331e5c8035d781c265e63121f917a0c&ascene=1&uin=MTcxODg3OTg2NA%3D%3D&devicetype=Windows+10+x64&version=6209007b&lang=zh_CN&exportkey=AWL8gGdsfXLf44soWg8KIlM%3D&pass_ticket=0DF%2FkfRAInpeFu7tc2y1H8g%2BIU47c3xVulvsNmbUBmiMIQ86w2w6nxs35ayF1Za0)


# References

1. Uusberg, A., Thiruchselvam, R., & Gross, J. J. (2014). Using distraction to regulate emotion: Insights from EEG theta dynamics. International Journal of Psychophysiology, 91(3), 254-260.
2. https://www.cnblogs.com/minks/p/5946442.html
3. 知乎: 如何通俗地讲解傅立叶分析和小波分析间的关系?
4. 武侠, 钟楚鹏, 丁玉珑, & 曲折. (2018). 利用时频分析研究非相位锁定脑电活动. 心理科学进展, v.26；No.216(08), 23-38.
5. https://neuroimage.usc.edu/brainstorm/Tutorials/TimeFrequency
6. 丛丰裕老师主页： http://www.escience.cn/people/cong/index.html
7.  
悦影科技 https://zhuanlan.zhihu.com/p/97394678
8. 脑电信号功能连接 http://blog.sina.com.cn/s/blog_60a7516201015m7q.html
9. [EEGLAB batch1](https://sccn.ucsd.edu/wiki/Makoto%27s_useful_EEGLAB_code#Example_of_batch_code_to_preprocess_multiple_subjects_.2808.2F08.2F2020_updated.29) [EEGLAB batch2](https://osf.io/wcyzn/)
